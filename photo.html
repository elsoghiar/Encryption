<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🔒 تشفير النص داخل الصور</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/eruda"></script>
    <script> eruda.init(); </script>

    <style>
        body { font-family: Arial, sans-serif; text-align: center; direction: rtl; background-color: #f5f5f5; }
        .container { max-width: 500px; margin: auto; padding: 20px; border: 1px solid #ccc; border-radius: 10px; background: white; }
        input, textarea, button { margin: 10px; padding: 10px; font-size: 16px; width: 80%; }
        canvas { display: none; }
    </style>
</head>
<body>

    <h2>🔐 تشفير النص داخل صورة وفك تشفيره</h2>

    <div class="container">
        <h3>إخفاء النص داخل صورة</h3>
        <input type="file" id="imageInput" accept="image/*"><br>
        <textarea id="textToHide" placeholder="📝 أدخل النص هنا"></textarea><br>
        <input type="password" id="encryptionKey" placeholder="🔑 أدخل مفتاح التشفير (اختياري)"><br>
        <button onclick="hideTextInImage()">🔐 تشفير النص</button>
        <a id="downloadLink" style="display:none;" download="encrypted.png">⬇️ تحميل الصورة المشفرة</a>
    </div>

    <br>

    <div class="container">
        <h3>🔍 استخراج النص من صورة</h3>
        <input type="file" id="imageDecodeInput" accept="image/*"><br>
        <input type="password" id="decryptionKey" placeholder="🔑 أدخل مفتاح فك التشفير (إن وجد)"><br>
        <button onclick="extractTextFromImage()">🔎 فك التشفير</button>
        <p id="extractedText"></p>
    </div>
    <div class="bottom-nav">
                <a href="index.html" class="nav-item">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-align-left">
                        <path d="M15 12H3" />
                        <path d="M17 18H3" />
                        <path d="M21 6H3" />
                    </svg>
                </a>
                <a href="photo.html" class="nav-item">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-image">
                        <rect width="18" height="18" x="3" y="3" rx="2" ry="2" />
                        <circle cx="9" cy="9" r="2" />
                        <path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21" />
                    </svg>
                </a>
                <a href="improve.html" class="nav-item">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z" />
                        <path d="M12 5 9.04 7.96a2.17 2.17 0 0 0 0 3.08c.82.82 2.13.85 3 .07l2.07-1.9a2.82 2.82 0 0 1 3.79 0l2.96 2.66" />
                        <path d="m18 15-2-2" />
                        <path d="m15 18-2-2" />
                    </svg>
                </a>
            </div>
</div>

    <canvas id="canvas"></canvas>

    <script>
        const DEFAULT_KEY = "SuperSecureKey123!@#"; // مفتاح افتراضي

        function hideTextInImage() {
            const fileInput = document.getElementById('imageInput');
            const textInput = document.getElementById('textToHide').value;
            let encryptionKey = document.getElementById('encryptionKey').value || DEFAULT_KEY;

            if (!fileInput.files[0] || !textInput) {
                alert("⚠️ يرجى اختيار صورة وإدخال نص.");
                return;
            }

            const reader = new FileReader();
            reader.onload = function(event) {
                const img = new Image();
                img.src = event.target.result;

                img.onload = function() {
                    const canvas = document.getElementById('canvas');
                    const ctx = canvas.getContext('2d');

                    canvas.width = img.width;
                    canvas.height = img.height;
                    ctx.drawImage(img, 0, 0);

                    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                    const pixels = imageData.data;

                    // 🔐 تشفير النص باستخدام CryptoJS
                    const encryptedText = CryptoJS.AES.encrypt(textInput, encryptionKey).toString();

                    let binaryText = '';
                    for (let i = 0; i < encryptedText.length; i++) {
                        binaryText += encryptedText.charCodeAt(i).toString(2).padStart(8, '0');
                    }

                    if (binaryText.length > pixels.length / 4) {
                        alert("⚠️ النص طويل جدًا بالنسبة لهذه الصورة.");
                        return;
                    }

                    // توزيع البيانات المشفرة على القنوات اللونية
                    let index = 0;
                    for (let i = 0; i < pixels.length && index < binaryText.length; i += 4) {
                        pixels[i] = (pixels[i] & 0xFE) | parseInt(binaryText[index]); // قناة R
                        pixels[i + 1] = (pixels[i + 1] & 0xFE) | parseInt(binaryText[index + 1] || '0'); // قناة G
                        pixels[i + 2] = (pixels[i + 2] & 0xFE) | parseInt(binaryText[index + 2] || '0'); // قناة B
                        index += 3;
                    }

                    ctx.putImageData(imageData, 0, 0);

                    const encryptedImage = canvas.toDataURL("image/png");
                    const downloadLink = document.getElementById('downloadLink');
                    downloadLink.href = encryptedImage;
                    downloadLink.style.display = 'block';

                    // 🧹 مسح البيانات بعد التشفير
                    document.getElementById('imageInput').value = '';
                    document.getElementById('textToHide').value = '';
                    document.getElementById('encryptionKey').value = '';
                };
            };
            reader.readAsDataURL(fileInput.files[0]);
        }

        function extractTextFromImage() {
            const fileInput = document.getElementById('imageDecodeInput');
            let decryptionKey = document.getElementById('decryptionKey').value || DEFAULT_KEY;

            if (!fileInput.files[0]) {
                alert("⚠️ يرجى اختيار صورة لفك التشفير.");
                return;
            }

            const reader = new FileReader();
            reader.onload = function(event) {
                const img = new Image();
                img.src = event.target.result;

                img.onload = function() {
                    const canvas = document.getElementById('canvas');
                    const ctx = canvas.getContext('2d');

                    canvas.width = img.width;
                    canvas.height = img.height;
                    ctx.drawImage(img, 0, 0);

                    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                    const pixels = imageData.data;

                    let binaryText = '';
                    for (let i = 0; i < pixels.length; i += 4) {
                        binaryText += (pixels[i] & 1).toString();
                        binaryText += (pixels[i + 1] & 1).toString();
                        binaryText += (pixels[i + 2] & 1).toString();
                    }

                    let extractedText = '';
                    for (let i = 0; i < binaryText.length; i += 8) {
                        const byte = binaryText.substr(i, 8);
                        const charCode = parseInt(byte, 2);
                        if (charCode === 0) break;
                        extractedText += String.fromCharCode(charCode);
                    }

                    try {
                        extractedText = CryptoJS.AES.decrypt(extractedText, decryptionKey).toString(CryptoJS.enc.Utf8);
                        document.getElementById('extractedText').innerText = "🔓 النص المستخرج: " + extractedText;
                    } catch (error) {
                        alert("⚠️ لم يتم العثور على نص صالح أو المفتاح غير صحيح.");
                    }
                };
            };
            reader.readAsDataURL(fileInput.files[0]);
        }
    </script>

</body>
</html>
